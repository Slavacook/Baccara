# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ - –ë–∞–∫–∫–∞—Ä–∞ –¢—Ä–µ–Ω–∞–∂—ë—Ä

## üéØ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–æ–¥—É

### –ì–ª–∞–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã |
|------|-----------|----------------|
| `GameController.gd` | –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä | `_on_winner_selected()`, `_on_payout_confirmed()`, `_on_survival_game_over()` |
| `GamePhaseManager.gd` | State Machine | `change_state()`, `on_error_occurred()` |
| `PayoutPopup.gd` | –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–ª–∞—Ç | `show_payout()`, `_on_chip_clicked()`, `_validate_payout()` |
| `SurvivalModeUI.gd` | –†–µ–∂–∏–º –≤—ã–∂–∏–≤–∞–Ω–∏—è | `lose_life()`, `activate()`, `reset()` |

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. PayoutPopup - –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã —Å—Ç–µ–∫–æ–≤

```gdscript
// –î–û–ë–ê–í–õ–ï–ù–ò–ï —Ñ–∏—à–∫–∏:
1. –ò—â–µ–º –ü–û–°–õ–ï–î–ù–ò–ô (rightmost) —Å—Ç–µ–∫ —ç—Ç–æ–≥–æ –Ω–æ–º–∏–Ω–∞–ª–∞
2. –ï—Å–ª–∏ —Å—Ç–µ–∫ –Ω–µ–ø–æ–ª–Ω—ã–π (<20) ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–µ–≥–æ
3. –ï—Å–ª–∏ –≤—Å–µ —Å—Ç–µ–∫–∏ –ø–æ–ª–Ω—ã–µ ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Å—Ç–µ–∫
4. –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ sorted –ø–æ–∑–∏—Ü–∏—é (—Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ: –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)

// –£–î–ê–õ–ï–ù–ò–ï —Ñ–∏—à–∫–∏:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ –õ–Æ–ë–û–ô —Å—Ç–µ–∫ –Ω–æ–º–∏–Ω–∞–ª–∞
2. –ù–∞—Ö–æ–¥–∏–º –ü–û–°–õ–ï–î–ù–ò–ô (rightmost) —Å—Ç–µ–∫ —ç—Ç–æ–≥–æ –Ω–æ–º–∏–Ω–∞–ª–∞
3. –£–¥–∞–ª—è–µ–º —Ñ–∏—à–∫—É –∏–∑ –ü–û–°–õ–ï–î–ù–ï–ì–û —Å—Ç–µ–∫–∞ (–Ω–µ –∏–∑ –∫–ª–∏–∫–Ω—É—Ç–æ–≥–æ!)
4. –ï—Å–ª–∏ —Å—Ç–µ–∫ –æ–ø—É—Å—Ç–µ–ª ‚Üí —É–¥–∞–ª—è–µ–º —Å—Ç–µ–∫, compact–∏—Ä—É–µ–º
```

### 2. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–æ–≤

```
‚â§6 —Å—Ç–µ–∫–æ–≤:  scale = 1.0,  slot size = 96√ó336px   (6 —Å–ª–æ—Ç–æ–≤)
>6 —Å—Ç–µ–∫–æ–≤:  scale = 0.6,  slot size = 57.6√ó201.6px  (10 —Å–ª–æ—Ç–æ–≤)

–ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞:
1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–µ–∫–∏
2. –£–¥–∞–ª—è–µ–º –∏–∑ —Å—Ç–∞—Ä—ã—Ö —Å–ª–æ—Ç–æ–≤
3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º —Å–ª–æ—Ç—ã —Å –Ω–æ–≤—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
4. –í—ã–∑—ã–≤–∞–µ–º stack.update_scale(new_scale) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–µ–∫–∞
5. –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—ã–µ —Å–ª–æ—Ç—ã

–§–∏—à–∫–∏ –≤—Å–µ–≥–¥–∞ –≤—ã—Ä–∞–≤–Ω–µ–Ω—ã –ø–æ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ (ALIGNMENT_END).
```

### 3. State Machine - –ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π

```
StartState
    ‚Üì (–Ω–∞–∂–∞–ª–∏ "–†–∞–∑–¥–∞—Ç—å")
DealingState
    ‚Üì (—Ä–∞–∑–¥–∞–ª–∏ 4 –∫–∞—Ä—Ç—ã)
CardsDealtState
    ‚Üì (–Ω–∞–∂–∞–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
    ‚îú‚Üí RevealedState (–µ—Å–ª–∏ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è / –±–µ–∑ —Ç—Ä–µ—Ç—å–∏—Ö)
    ‚îî‚Üí PlayerCardOpenedState (–µ—Å–ª–∏ —Ç—Ä–µ—Ç—å—è –∫–∞—Ä—Ç–∞ –∏–≥—Ä–æ–∫—É)
           ‚Üì (–Ω–∞–∂–∞–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)
       RevealedState
```

### 4. Survival Mode - –¢–æ—á–∫–∏ –ø–æ—Ç–µ—Ä–∏ –∂–∏–∑–Ω–∏

```gdscript
// –í GameController:
- –í—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞

// –í States (—á–µ—Ä–µ–∑ on_error_occurred()):
- –ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è, –Ω–æ –≤—ã–±—Ä–∞–Ω–∞ —Ç—Ä–µ—Ç—å—è –∫–∞—Ä—Ç–∞ (CardsDealtState)
- –û–±–∞ –¥–æ–ª–∂–Ω—ã –≤–∑—è—Ç—å, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ (CardsDealtState)
- –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –≤–∑—è—Ç—å, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª (CardsDealtState √ó 2 –º–µ—Å—Ç–∞)
- –ë–∞–Ω–∫–∏—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –±—Ä–∞—Ç—å, –Ω–æ –≤—ã–±—Ä–∞–ª–∏ (CardsDealtState √ó 3 –º–µ—Å—Ç–∞)
- –ë–∞–Ω–∫–∏—Ä –¥–æ–ª–∂–µ–Ω –≤–∑—è—Ç—å, –Ω–æ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ (CardsDealtState + PlayerCardOpenedState)
- –ë–∞–Ω–∫–∏—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –±—Ä–∞—Ç—å, –Ω–æ –≤—ã–±—Ä–∞–ª–∏ (PlayerCardOpenedState)

–ò–¢–û–ì–û: 12 —Ç–æ—á–µ–∫ –ø–æ—Ç–µ—Ä–∏ –∂–∏–∑–Ω–∏
```

---

## üìê –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

### State Pattern
`State` (–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å) ‚Üí 5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- –õ—ë–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π

### Manager Pattern
–ö–∞–∂–¥—ã–π –∞—Å–ø–µ–∫—Ç –∏–≥—Ä—ã –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:
- `CardTextureManager` - –∫–∞—Ä—Ç—ã
- `StatsManager` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `UIManager` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- `ToastManager` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `LimitsManager` - –ª–∏–º–∏—Ç—ã
- `SaveManager` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (singleton)

### Signal-based Communication
–°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—ã:
```gdscript
signal payout_confirmed(is_correct: bool, collected: int, expected: int)
signal game_over(rounds_survived: int)
signal restart_game()
```

---

## üêõ –ß–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: SubResource –≤ .tscn —Ñ–∞–π–ª–∞—Ö
**–û—à–∏–±–∫–∞**: "referenced non-existent resource"
**–†–µ—à–µ–Ω–∏–µ**: `[sub_resource]` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–ï–†–ï–î –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ `[node]`

```gdscript
// –ü–†–ê–í–ò–õ–¨–ù–û:
[ext_resource ...]
[sub_resource ...]  ‚Üê –û–ø—Ä–µ–¥–µ–ª—è–µ–º
[node ...]
    label_settings = SubResource(...)  ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º

// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
[ext_resource ...]
[node ...]
    label_settings = SubResource(...)  ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º
[sub_resource ...]  ‚Üê –û–ø—Ä–µ–¥–µ–ª—è–µ–º (–ø–æ–∑–¥–Ω–æ!)
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –°—Ç–µ–∫–∏ "–ø—Ä—ã–≥–∞—é—Ç" –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
**–ü—Ä–∏—á–∏–Ω–∞**: VBoxContainer —Å Spacer —Ç–æ–ª–∫–∞–ª –∫–æ–Ω—Ç–µ–Ω—Ç –≤–≤–µ—Ä—Ö
**–†–µ—à–µ–Ω–∏–µ**: Anchor-based –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```gdscript
texture_rect.anchor_bottom = 1.0  # –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –Ω–∏–∑—É
texture_rect.offset_top = -height  # –†–æ—Å—Ç –≤–≤–µ—Ä—Ö
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Duplicate signal connections
**–û—à–∏–±–∫–∞**: "Signal already connected"
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
```gdscript
if not stack.container.gui_input.is_connected(_on_stack_gui_input):
    stack.container.gui_input.connect(_on_stack_gui_input.bind(...))
```

---

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```gdscript
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
print("Current state: ", phase_manager.current_state.get_script().resource_path)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–µ–∫–æ–≤:
for i in range(chip_stacks.size()):
    print("Stack %d: denom=%d, count=%d" % [i, chip_stacks[i].denomination, chip_stacks[i].count])

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –≤—ã–∂–∏–≤–∞–Ω–∏—è:
print("Lives: %d, Rounds: %d, Active: %s" % [survival_ui.current_lives, survival_rounds_completed, survival_ui.is_active])
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å—Ç–µ–∫–∞**: ~100 —Å—Ç—Ä–æ–∫
- **–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä State**: ~150 —Å—Ç—Ä–æ–∫
- **PayoutPopup.gd**: ~450 —Å—Ç—Ä–æ–∫ (—Å–∞–º—ã–π –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª)
- **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤**: ~30
- **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞**: ~3500

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

- [x] –í—Å–µ –æ—à–∏–±–∫–∏ –∏–∑ –æ—Ç–ª–∞–¥—á–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- [x] –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤ –∫–æ–Ω—Å–æ–ª–∏
- [x] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (RU/EN)
- [x] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] –†–µ–∂–∏–º –≤—ã–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- [x] PayoutPopup –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã
- [x] –°—Ç–µ–∫–∏ —Ñ–∏—à–µ–∫ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] Game Over –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –≤—Å–µ—Ö –∂–∏–∑–Ω–µ–π
- [x] –†–µ—Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã —Ä–∞–±–æ—Ç–∞–µ—Ç

---

**–°–æ–∑–¥–∞–Ω–æ**: 2025-11-18
**–î–ª—è**: –ë—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã
